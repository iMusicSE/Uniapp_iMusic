# 搜索功能按需加载优化说明

## 优化目标
将搜索功能从"批量预加载"模式改为"按需加载"模式，提升搜索响应速度和用户体验。

## 问题分析

### 原有实现的问题
1. **搜索后立即批量获取所有歌曲详情**：当搜索返回30首歌曲时，需要发起30次详情请求
2. **加载时间长**：用户需要等待所有详情加载完成才能看到完整结果
3. **资源浪费**：用户可能只播放1-2首歌，但却加载了所有歌曲的详细信息

### 优化方案
采用"懒加载"策略，只在需要时才加载歌曲详细信息：
- 搜索时只显示基础信息（歌名、歌手、专辑）
- 用户点击播放、添加到播放列表等操作时，才加载该歌曲的详细信息（封面图等）
- 使用本地缓存避免重复请求

## 修改内容

### 1. search.vue 优化

#### 移除批量加载逻辑
```javascript
// ❌ 旧代码：搜索后批量获取详情
const songIds = songs.map(song => song.id)
const detailedSongs = await this.getBatchSongDetails(songIds)
if (detailedSongs && detailedSongs.length > 0) {
    this.searchResults = detailedSongs.map(song => ({
        ...song,
        vip: songs.find(s => s.id === song.id)?.fee === 1 || false
    }))
}

// ✅ 新代码：只返回基础信息
this.searchResults = songs.map(song => ({
    id: song.id,
    name: song.name,
    artistName: song.artists?.map(artist => artist.name).join(', ') || '未知歌手',
    albumName: song.album?.name || song.al?.name || '未知专辑',
    albumPic: '/static/logo.png', // 使用默认封面
    url: `https://music.163.com/song/media/outer/url?id=${song.id}.mp3`,
    vip: song.fee === 1
}))
```

#### 移除相关引入和方法
- 移除 `getBatchSongDetails` 的导入
- 移除 `getBatchSongDetails` 方法

### 2. SongList.vue 优化

#### 添加本地缓存机制
```javascript
data() {
    return {
        // 本地缓存：存储已加载详细信息的歌曲
        enrichedSongsCache: {}
    }
}
```

#### 优化播放逻辑
```javascript
async handlePlay(song, index) {
    // 1. 检查缓存
    let songToPlay = this.enrichedSongsCache[song.id] || song
    
    // 2. 判断是否需要加载详细信息
    const needDetail = (!songToPlay.albumPic || songToPlay.albumPic === '/static/logo.png') 
        && !this.enrichedSongsCache[song.id]
    
    // 3. 按需加载
    if (needDetail) {
        uni.showLoading({ title: '加载中...', mask: true })
        songToPlay = await this.enrichSongDetail(song)
        this.enrichedSongsCache[song.id] = songToPlay
        uni.hideLoading()
    }
    
    // 4. 播放歌曲
    this.playSong({ song: songToPlay, playlist: this.songs })
}
```

#### 添加统一的详情获取方法
```javascript
async getEnrichedSong(song) {
    // 优先使用缓存
    if (this.enrichedSongsCache[song.id]) {
        return this.enrichedSongsCache[song.id]
    }
    
    // 获取并缓存
    const enrichedSong = await this.enrichSongDetail(song)
    this.enrichedSongsCache[song.id] = enrichedSong
    return enrichedSong
}
```



